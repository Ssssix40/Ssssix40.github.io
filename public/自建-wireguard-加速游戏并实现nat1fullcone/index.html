<!DOCTYPE html>
<html lang="zh-CN">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/images/favicon.png" />
<title>自建 wireguard 加速游戏并实现NAT1(fullcone) | SpiritShaman</title>
<meta name="title" content="自建 wireguard 加速游戏并实现NAT1(fullcone)" />
<meta name="description" content="1. 前言 参考本文可以实现以下几点需求：
通过wireguard建立隧道以及给linux内核添加FULLCONE模块，实现一条NAT1的虚假IPLC。 因为wireguard本身会加速所有的流量，所以通过netch配合虚假IPLC局域网中转机的socks5代理服务达到在pc只加速游戏的效果。 @#￥%……&amp;*（ 本文实现的方式主要是通过打隧道的方式实现一个虚假的iplc，也就是说，如果您完全按照我的教程走的话，您需要具备以下的前提：
一台延迟尚可且具有公网ip的落地vps，毕竟是用于打游戏，延迟相对比较重要，同时FULLCONE需要公网IP支持。 一台中转的服务器，建议是局域网内的一台虚拟机或者一个树莓派。我这边是自己组了一台pve服务器，然后开了个lxc。需要注意的是，当服务开启之后，该中转机的所有流量都会走wireguard。 当然还有一定的linux知识，因为本教程在一些细节方面可能讲的并不是那么全面。 本文会根据不同的需求拆开成本体以及DLC两部分，完成本体就可以实现本文所述功能，但是DLC则提供了一些特殊的功能。比如udp2raw可以帮助wireguard躲避运营商给你时不时的一个断流打击。
2. 本体 2.1 安装wireguard 本文主要介绍ubuntu的安装方式，其他linux发行版敬请请参考官方教程或者google。
您需要在落地和中转机器上都安装wireguard，落地机器作为server而中转机器作为client。
su - root apt update # ubuntu 18.04 及以上版本 apt install wireguard resolvconf -y # ubuntu 16.04 及以下版本 add-apt-repository ppa:wireguard/wireguard apt update apt install wireguard resolvconf -y # 在安装完成之后建议重启一下 # reboot 2.2 配置wireguard 在落地机器依次输入下列命令:
# 开启ipv4流量转发 echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf sysctl -p # 创建并进入WireGuard文件夹 mkdir -p /etc/wireguard &amp;&amp; chmod 0777 /etc/wireguard cd /etc/wireguard umask 077 # 生成服务器和客户端密钥对 wg genkey | tee server_privatekey | wg pubkey &gt; server_publickey wg genkey | tee client_privatekey | wg pubkey &gt; client_publickey 通过ifconfig检查主网卡名称，一般会为eth0或者ens3。" />
<meta name="keywords" content="Tutorials,wireguard,games," />


<meta property="og:title" content="自建 wireguard 加速游戏并实现NAT1(fullcone)" />
<meta property="og:description" content="1. 前言 参考本文可以实现以下几点需求：
通过wireguard建立隧道以及给linux内核添加FULLCONE模块，实现一条NAT1的虚假IPLC。 因为wireguard本身会加速所有的流量，所以通过netch配合虚假IPLC局域网中转机的socks5代理服务达到在pc只加速游戏的效果。 @#￥%……&amp;*（ 本文实现的方式主要是通过打隧道的方式实现一个虚假的iplc，也就是说，如果您完全按照我的教程走的话，您需要具备以下的前提：
一台延迟尚可且具有公网ip的落地vps，毕竟是用于打游戏，延迟相对比较重要，同时FULLCONE需要公网IP支持。 一台中转的服务器，建议是局域网内的一台虚拟机或者一个树莓派。我这边是自己组了一台pve服务器，然后开了个lxc。需要注意的是，当服务开启之后，该中转机的所有流量都会走wireguard。 当然还有一定的linux知识，因为本教程在一些细节方面可能讲的并不是那么全面。 本文会根据不同的需求拆开成本体以及DLC两部分，完成本体就可以实现本文所述功能，但是DLC则提供了一些特殊的功能。比如udp2raw可以帮助wireguard躲避运营商给你时不时的一个断流打击。
2. 本体 2.1 安装wireguard 本文主要介绍ubuntu的安装方式，其他linux发行版敬请请参考官方教程或者google。
您需要在落地和中转机器上都安装wireguard，落地机器作为server而中转机器作为client。
su - root apt update # ubuntu 18.04 及以上版本 apt install wireguard resolvconf -y # ubuntu 16.04 及以下版本 add-apt-repository ppa:wireguard/wireguard apt update apt install wireguard resolvconf -y # 在安装完成之后建议重启一下 # reboot 2.2 配置wireguard 在落地机器依次输入下列命令:
# 开启ipv4流量转发 echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf sysctl -p # 创建并进入WireGuard文件夹 mkdir -p /etc/wireguard &amp;&amp; chmod 0777 /etc/wireguard cd /etc/wireguard umask 077 # 生成服务器和客户端密钥对 wg genkey | tee server_privatekey | wg pubkey &gt; server_publickey wg genkey | tee client_privatekey | wg pubkey &gt; client_publickey 通过ifconfig检查主网卡名称，一般会为eth0或者ens3。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/%E8%87%AA%E5%BB%BA-wireguard-%E5%8A%A0%E9%80%9F%E6%B8%B8%E6%88%8F%E5%B9%B6%E5%AE%9E%E7%8E%B0nat1fullcone/" /><meta property="og:image" content="http://localhost:1313/images/share.png" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-13T00:00:00+00:00" /><meta property="og:site_name" content="SpiritShaman" />




<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/share.png" /><meta name="twitter:title" content="自建 wireguard 加速游戏并实现NAT1(fullcone)"/>
<meta name="twitter:description" content="1. 前言 参考本文可以实现以下几点需求：
通过wireguard建立隧道以及给linux内核添加FULLCONE模块，实现一条NAT1的虚假IPLC。 因为wireguard本身会加速所有的流量，所以通过netch配合虚假IPLC局域网中转机的socks5代理服务达到在pc只加速游戏的效果。 @#￥%……&amp;*（ 本文实现的方式主要是通过打隧道的方式实现一个虚假的iplc，也就是说，如果您完全按照我的教程走的话，您需要具备以下的前提：
一台延迟尚可且具有公网ip的落地vps，毕竟是用于打游戏，延迟相对比较重要，同时FULLCONE需要公网IP支持。 一台中转的服务器，建议是局域网内的一台虚拟机或者一个树莓派。我这边是自己组了一台pve服务器，然后开了个lxc。需要注意的是，当服务开启之后，该中转机的所有流量都会走wireguard。 当然还有一定的linux知识，因为本教程在一些细节方面可能讲的并不是那么全面。 本文会根据不同的需求拆开成本体以及DLC两部分，完成本体就可以实现本文所述功能，但是DLC则提供了一些特殊的功能。比如udp2raw可以帮助wireguard躲避运营商给你时不时的一个断流打击。
2. 本体 2.1 安装wireguard 本文主要介绍ubuntu的安装方式，其他linux发行版敬请请参考官方教程或者google。
您需要在落地和中转机器上都安装wireguard，落地机器作为server而中转机器作为client。
su - root apt update # ubuntu 18.04 及以上版本 apt install wireguard resolvconf -y # ubuntu 16.04 及以下版本 add-apt-repository ppa:wireguard/wireguard apt update apt install wireguard resolvconf -y # 在安装完成之后建议重启一下 # reboot 2.2 配置wireguard 在落地机器依次输入下列命令:
# 开启ipv4流量转发 echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf sysctl -p # 创建并进入WireGuard文件夹 mkdir -p /etc/wireguard &amp;&amp; chmod 0777 /etc/wireguard cd /etc/wireguard umask 077 # 生成服务器和客户端密钥对 wg genkey | tee server_privatekey | wg pubkey &gt; server_publickey wg genkey | tee client_privatekey | wg pubkey &gt; client_publickey 通过ifconfig检查主网卡名称，一般会为eth0或者ens3。"/>



<meta itemprop="name" content="自建 wireguard 加速游戏并实现NAT1(fullcone)">
<meta itemprop="description" content="1. 前言 参考本文可以实现以下几点需求：
通过wireguard建立隧道以及给linux内核添加FULLCONE模块，实现一条NAT1的虚假IPLC。 因为wireguard本身会加速所有的流量，所以通过netch配合虚假IPLC局域网中转机的socks5代理服务达到在pc只加速游戏的效果。 @#￥%……&amp;*（ 本文实现的方式主要是通过打隧道的方式实现一个虚假的iplc，也就是说，如果您完全按照我的教程走的话，您需要具备以下的前提：
一台延迟尚可且具有公网ip的落地vps，毕竟是用于打游戏，延迟相对比较重要，同时FULLCONE需要公网IP支持。 一台中转的服务器，建议是局域网内的一台虚拟机或者一个树莓派。我这边是自己组了一台pve服务器，然后开了个lxc。需要注意的是，当服务开启之后，该中转机的所有流量都会走wireguard。 当然还有一定的linux知识，因为本教程在一些细节方面可能讲的并不是那么全面。 本文会根据不同的需求拆开成本体以及DLC两部分，完成本体就可以实现本文所述功能，但是DLC则提供了一些特殊的功能。比如udp2raw可以帮助wireguard躲避运营商给你时不时的一个断流打击。
2. 本体 2.1 安装wireguard 本文主要介绍ubuntu的安装方式，其他linux发行版敬请请参考官方教程或者google。
您需要在落地和中转机器上都安装wireguard，落地机器作为server而中转机器作为client。
su - root apt update # ubuntu 18.04 及以上版本 apt install wireguard resolvconf -y # ubuntu 16.04 及以下版本 add-apt-repository ppa:wireguard/wireguard apt update apt install wireguard resolvconf -y # 在安装完成之后建议重启一下 # reboot 2.2 配置wireguard 在落地机器依次输入下列命令:
# 开启ipv4流量转发 echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf sysctl -p # 创建并进入WireGuard文件夹 mkdir -p /etc/wireguard &amp;&amp; chmod 0777 /etc/wireguard cd /etc/wireguard umask 077 # 生成服务器和客户端密钥对 wg genkey | tee server_privatekey | wg pubkey &gt; server_publickey wg genkey | tee client_privatekey | wg pubkey &gt; client_publickey 通过ifconfig检查主网卡名称，一般会为eth0或者ens3。"><meta itemprop="datePublished" content="2020-11-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-11-13T00:00:00+00:00" />
<meta itemprop="wordCount" content="589"><meta itemprop="image" content="http://localhost:1313/images/share.png" />
<meta itemprop="keywords" content="Tutorials,wireguard,games," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
      --width: 800px;
      --font-main: Verdana, sans-serif;
      --font-secondary: Verdana, sans-serif;
      --font-scale: 1em;
      --background-color: #fff;
      --heading-color: #222;
      --text-color: #444;
      --link-color: #3273dc;
      --visited-color:  #8b6fcb;
      --code-background-color: #f2f2f2;
      --code-color: #222;
      --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
      :root {
          --background-color: #333;
          --heading-color: #eee;
          --text-color: #ddd;
          --link-color: #8cc2dd;
          --visited-color:  #8b6fcb;
          --code-background-color: #777;
          --code-color: #ddd;
          --blockquote-color: #ccc;
      }
  }

  body {
      font-family: var(--font-secondary);
      font-size: var(--font-scale);
      margin: auto;
      padding: 20px;
      max-width: var(--width);
      text-align: left;
      background-color: var(--background-color);
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.5;
      color: var(--text-color);
  }

  h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-main);
      color: var(--heading-color);
  }

  a {
      color: var(--link-color);
      cursor: pointer;
      text-decoration: none;
  }

  a:hover {
      text-decoration: underline; 
  }

  nav a {
      margin-right: 8px;
  }

  strong, b {
      color: var(--heading-color);
  }

  button {
      margin: 0;
      cursor: pointer;
  }

  main {
      line-height: 1.6;
  }

  table {
      width: 100%;
  }

  hr {
      border: 0;
      border-top: 1px dashed;
  }

  img {
      max-width: 100%;
  }

  code {
      font-family: monospace;
      padding: 2px;
      background-color: var(--code-background-color);
      color: var(--code-color);
      border-radius: 3px;
  }

  blockquote {
      border-left: 1px solid #999;
      color: var(--code-color);
      padding-left: 20px;
      font-style: italic;
  }

  footer {
      padding: 25px 0;
      text-align: center;
  }

  .title:hover {
      text-decoration: none;
  }

  .title h1 {
      font-size: 1.5em;
  }

  .inline {
      width: auto !important;
  }

  .highlight, .code {
      padding: 1px 15px;
      background-color: var(--code-background-color);
      color: var(--code-color);
      border-radius: 3px;
      margin-block-start: 1em;
      margin-block-end: 1em;
      overflow-x: auto;
  }

   
  ul.blog-posts {
      list-style-type: none;
      padding: unset;
  }

  ul.blog-posts li {
      display: flex;
  }

  ul.blog-posts li span {
      flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
      color: var(--visited-color);
  }
</style>

</head>

<body>
  <header><a href="/" class="title">
  <h2>SpiritShaman</h2>
</a>
<nav><a href="/">Home</a>


<a href="/blog">Blog</a>

</nav>
</header>
  <main>

<h1>自建 wireguard 加速游戏并实现NAT1(fullcone)</h1>
<p>
  <i>
    <time datetime='2020-11-13'>
      13 Nov, 2020
    </time>
  </i>
</p>

<content>
  <h2 id="1-前言">1. 前言</h2>
<p>参考本文可以实现以下几点需求：</p>
<ol>
<li>通过wireguard建立隧道以及给linux内核添加FULLCONE模块，实现一条NAT1的<strong>虚假</strong>IPLC。</li>
<li>因为wireguard本身会加速所有的流量，所以通过<code>netch</code>配合<strong>虚假</strong><code>IPLC</code>局域网中转机的<code>socks5</code>代理服务达到在pc只加速游戏的效果。</li>
<li>@#￥%……&amp;*（</li>
</ol>
<p>本文实现的方式主要是通过打隧道的方式实现一个<strong>虚假</strong>的<code>iplc</code>，也就是说，如果您完全按照我的教程走的话，您需要具备以下的前提：</p>
<ol>
<li>一台延迟尚可且具有公网ip的落地vps，毕竟是用于打游戏，延迟相对比较重要，同时FULLCONE需要公网IP支持。</li>
<li>一台中转的服务器，建议是局域网内的一台虚拟机或者一个树莓派。我这边是自己组了一台<code>pve</code>服务器，然后开了个lxc。需要注意的是，当服务开启之后，该中转机的所有流量都会走<code>wireguard</code>。</li>
<li>当然还有一定的linux知识，因为本教程在一些细节方面可能讲的并不是那么全面。</li>
</ol>
<p>本文会根据不同的需求拆开成<a href="#2-%E6%9C%AC%E4%BD%93">本体</a>以及<a href="#3-dlc">DLC</a>两部分，完成<strong>本体</strong>就可以实现本文所述功能，但是<strong>DLC</strong>则提供了一些特殊的功能。比如<code>udp2raw</code>可以帮助<code>wireguard</code>躲避运营商给你时不时的一个断流打击。</p>
<h2 id="2-本体">2. 本体</h2>
<h3 id="21-安装wireguard">2.1 安装wireguard</h3>
<p>本文主要介绍<code>ubuntu</code>的安装方式，其他linux发行版敬请请参考<a href="https://www.wireguard.com/install/">官方教程</a>或者google。</p>
<p>您需要在落地和中转机器上都安装wireguard，落地机器作为<strong>server</strong>而中转机器作为<strong>client</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>su - root
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu 18.04 及以上版本</span>
</span></span><span style="display:flex;"><span>apt install wireguard resolvconf -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu 16.04 及以下版本</span>
</span></span><span style="display:flex;"><span>add-apt-repository ppa:wireguard/wireguard
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span>apt install wireguard resolvconf -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在安装完成之后建议重启一下</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># reboot</span>
</span></span></code></pre></div><h3 id="22-配置wireguard">2.2 配置wireguard</h3>
<p>在<strong>落地机器</strong>依次输入下列命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 开启ipv4流量转发</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sysctl -p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建并进入WireGuard文件夹</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/wireguard <span style="color:#f92672">&amp;&amp;</span> chmod <span style="color:#ae81ff">0777</span> /etc/wireguard
</span></span><span style="display:flex;"><span>cd /etc/wireguard
</span></span><span style="display:flex;"><span>umask <span style="color:#ae81ff">077</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成服务器和客户端密钥对</span>
</span></span><span style="display:flex;"><span>wg genkey | tee server_privatekey | wg pubkey &gt; server_publickey
</span></span><span style="display:flex;"><span>wg genkey | tee client_privatekey | wg pubkey &gt; client_publickey
</span></span></code></pre></div><p>通过<code>ifconfig</code>检查主网卡名称，一般会为<code>eth0</code>或者<code>ens3</code>。</p>
<p>生成server配置文件<code>/etc/wireguard/wg0.conf</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 重要！如果名字不是eth0, 以下PostUp和PostDown处里面的eth0替换成自己服务器显示的名字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ListenPort为端口号，可以自己设置想使用的数字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以下内容一次性粘贴执行，不要分行执行</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Interface]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PrivateKey = </span><span style="color:#66d9ef">$(</span>cat server_privatekey<span style="color:#66d9ef">)</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Address = 10.0.0.1/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ListenPort = 52540
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DNS = 8.8.8.8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  MTU = 1200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Peer]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PublicKey = </span><span style="color:#66d9ef">$(</span>cat client_publickey<span style="color:#66d9ef">)</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  AllowedIPs = 10.0.0.2/32 &#34;</span> &gt; wg0.conf
</span></span></code></pre></div><p>生成client配置文件<code>/etc/wireguard/client.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Endpoint是自己服务器ip和服务端配置文件中设置的端口号，自己在本地编辑好再粘贴到SSH里</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以下内容一次性粘贴执行，不要分行执行</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Interface]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PrivateKey = </span><span style="color:#66d9ef">$(</span>cat client_privatekey<span style="color:#66d9ef">)</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Address = 10.0.0.2/24
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DNS = 8.8.8.8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  MTU = 1200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Peer]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PublicKey = </span><span style="color:#66d9ef">$(</span>cat server_publickey<span style="color:#66d9ef">)</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Endpoint = 1.2.3.4:52540
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  AllowedIPs = 0.0.0.0/0, ::0/0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  PersistentKeepalive = 25 &#34;</span> &gt; client.conf
</span></span></code></pre></div><p>此时需要将<code>clinet.conf</code>的内容复制到<strong>中转机器</strong>的<code>/etc/wireguard/wg0.conf</code>里面。</p>
<p>然后在两台机器上分别启动wireguard，wireguard的部分命令如下：</p>
<p><strong>请特别注意，中转机器开启wg之后，无法通过ssh访问，需要从落地机器访问回来</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 启动WireGuard</span>
</span></span><span style="display:flex;"><span>wg-quick up wg0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停止WireGuard</span>
</span></span><span style="display:flex;"><span>wg-quick down wg0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看WireGuard运行状态</span>
</span></span><span style="display:flex;"><span>wg
</span></span></code></pre></div><p>到此时，一个<strong>虚假</strong>的<code>IPLC</code>了。</p>
<p>可以在中转机器执行如下命令进行测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl ifconfig.me
</span></span><span style="display:flex;"><span>&gt; 1.2.3.4 <span style="color:#75715e"># 注意此处显示的应该是你的落地机器ip</span>
</span></span><span style="display:flex;"><span>ping 10.0.0.1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 正常应该是可以ping通的</span>
</span></span></code></pre></div><h3 id="23-开启fullcone-nat">2.3 开启FULLCONE NAT</h3>
<p>虽然此时<code>IPLC</code>已经打通，但是此时的NAT类型并不是NAT1，而是NAT4：Symmetric NAT。</p>
<p>（可以通过<a href="#31-pystun">pystun</a>验证，非必须步骤)</p>
<p>这个原因是因为</p>
<blockquote>
<p>TLDR: Linux内核树上未实现真正意义上的Full Cone NAT，Linux的 SNAT/MASQUERADE（以iptables的配置为例）均是Symmetric NAT。</p>
</blockquote>
<p>所以，此时我们要从linux的内核下手，实现FULLCONE。</p>
<p>安装完整的内核：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt install linux-image-<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>安装一些依赖：（一般需要的都装好了，不通的发行版可能需求不一样 ，缺什么装什么就好了）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt install gcc autoconf autogen libtool pkg-config libgmp3-dev -y
</span></span></code></pre></div><p>下载一些软件的源码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ~
</span></span><span style="display:flex;"><span>mkdir fullcone
</span></span><span style="display:flex;"><span>cd fullcone
</span></span><span style="display:flex;"><span>git clone git://git.netfilter.org/libmnl
</span></span><span style="display:flex;"><span>git clone git://git.netfilter.org/libnftnl.git
</span></span><span style="display:flex;"><span>git clone  git://git.netfilter.org/iptables.git
</span></span><span style="display:flex;"><span>git clone https://github.com/Chion82/netfilter-full-cone-nat.git
</span></span></code></pre></div><h4 id="231-编译libmnl">2.3.1 编译libmnl</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ~/fullcone/libmnl
</span></span><span style="display:flex;"><span>sh autogen.sh
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><p>然后:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>whereis libmnl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; libmnl: /usr/local/lib/libmnl.so /usr/local/lib/libmnl.la /usr/include/libmnl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ldd /usr/local/lib/libmnl.so
</span></span></code></pre></div><h4 id="232-编译libnftnl">2.3.2 编译libnftnl</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ~/fullcone/libnftnl
</span></span><span style="display:flex;"><span>sh autogen.sh
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><h4 id="233-编译和临时启用netfilter-full-cone-nat">2.3.3 编译和临时启用netfilter-full-cone-nat</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ~/fullcone/netfilter-full-cone-nat
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>insmod xt_FULLCONENAT.ko
</span></span><span style="display:flex;"><span><span style="color:#75715e">#如果编译模块报错，请安装kernel-devel,载入模块报错Unknown symbol in module ，先modprobe nf_nat 再载入模块。</span>
</span></span></code></pre></div><h4 id="234-编译和替换iptables">2.3.4 编译和替换iptables</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ~/fullcone/iptables/
</span></span><span style="display:flex;"><span>cp ~/fullcone/netfilter-full-cone-nat/libipt_FULLCONENAT.c ~/fullcone/iptables/extensions/
</span></span><span style="display:flex;"><span>ln -sfv /usr/sbin/xtables-multi /usr/bin/iptables-xml
</span></span><span style="display:flex;"><span>./autogen.sh
</span></span><span style="display:flex;"><span>PKG_CONFIG_PATH<span style="color:#f92672">=</span>/usr/local/lib/pkgconfig
</span></span><span style="display:flex;"><span>export PKG_CONFIG_PATH
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#先关闭iptables</span>
</span></span><span style="display:flex;"><span>systemctl stop iptables
</span></span><span style="display:flex;"><span><span style="color:#75715e">#进入相应目录，并覆盖相关文件</span>
</span></span><span style="display:flex;"><span>cd /usr/local/sbin
</span></span><span style="display:flex;"><span>cp /usr/local/sbin/iptables /sbin/   
</span></span><span style="display:flex;"><span>cp /usr/local/sbin/iptables-restore /sbin/
</span></span><span style="display:flex;"><span>cp /usr/local/sbin/iptables-save /sbin/
</span></span></code></pre></div><h4 id="235-检验fullcone">2.3.5 检验fullcone</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iptables -t nat -A POSTROUTING -o eth0 -j FULLCONENAT <span style="color:#75715e"># 没有错误</span>
</span></span><span style="display:flex;"><span>lsmod | grep xt_FULLCONENAT <span style="color:#75715e"># 有结果</span>
</span></span></code></pre></div><p><a href="https://imgchr.com/i/Dp5hIP"><img src="https://s3.ax1x.com/2020/11/13/Dp5hIP.png" alt="正常结果"></a></p>
<h4 id="236-开启自动加载">2.3.6 开启自动加载</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mv ~/fullcone/netfilter-full-cone-nat/xt_FULLCONENAT.ko  /lib/modules/<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>/
</span></span><span style="display:flex;"><span>depmod
</span></span></code></pre></div><p>新建编辑<code>/etc/modules-load.d/fullconenat.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>xt_FULLCONENAT
</span></span></code></pre></div><p>验证:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>lsmod | grep xt_FULLCONENAT
</span></span></code></pre></div><p><em>ps</em>:</p>
<p>此处如果没有结果，可能是内核更新了，请重新执行</p>
<pre tabindex="0"><code class="language-shel" data-lang="shel">cd ~/fullcone/netfilter-full-cone-nat
make
mv ~/fullcone/netfilter-full-cone-nat/xt_FULLCONENAT.ko  /lib/modules/$(uname -r)/
depmod
</code></pre><p>然后重启即可</p>
<h3 id="24-修改wireguard配置">2.4 修改wireguard配置</h3>
<p>在落地机器修改<code>/etc/wireguard/wg0.conf</code>:</p>
<p>将<code>postup</code> 尾部的<code>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</code>修改为<code>iptables -t nat -A POSTROUTING -o eth0 -j FULLCONENAT</code></p>
<p>将<code>postdown</code>尾部的<code>iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</code>修改为<code>iptables -t nat -D POSTROUTING -o eth0 -j FULLCONENAT</code></p>
<p>重启落地机器的wireguard网卡:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wg-quick down wg0
</span></span><span style="display:flex;"><span>wg-quick up wg0
</span></span></code></pre></div><p>此时我们已经实现了一个具有NAT1的<strong>虚假</strong>的<code>IPLC</code>。</p>
<h3 id="25-加速游戏">2.5 加速游戏</h3>
<p>本文用到的游戏加速软件为<a href="https://github.com/NetchX/Netch">netch</a>，netch支持常见的的远程代理协议，具体在其github有提供。</p>
<p>至于那些@#￥%……&amp;……的■■■的■■■■，本文暂且不表，各位自由发挥。</p>
<p>我们只需要将这些服务搭载在局域网的中转机器上， 然后通过PC的netch软件连接，就可以实现nat1的游戏加速了。</p>
<p>唯一需要注意的一点是：搭建的这个服务需要支持完整的udp，否则之前的一切努力都白费了。</p>
<p>当然搭建单纯的socks5服务(比如:dante-server)也是可以的，但是由于本人遇到一些奇怪的问题，所以此处也就不贴教程了。</p>
<h2 id="3-dlc">3. DLC</h2>
<h3 id="31-pystun">3.1 pystun</h3>
<p>pystun是一个可以检测linux服务器nat类型的工具。</p>
<p>要安装pystun需要借助于python的包管理工具<code>pip</code>。</p>
<p>执行下面命令安装<code>pip</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
</span></span><span style="display:flex;"><span>python get-pip.py
</span></span></code></pre></div><p>通过<code>pip</code>安装pystun:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install pystun3
</span></span></code></pre></div><p>执行<code>pystun3</code>应该会得到如下结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>NAT Type: Full Cone
</span></span><span style="display:flex;"><span>External IP: your ip
</span></span><span style="display:flex;"><span>External Port: Random Port
</span></span></code></pre></div><p>其中NAT Type对应了你的机器NAT类型。具体NAT类型的分别敬请google。在本文中想要的到最终结果为NAT1，即FULLCONE。</p>
<h3 id="32-udp2raw">3.2 udp2raw</h3>
<p>因为wireguard使用udp传输，电信经常在我玩的热火朝天的时候给我断流，所以我需要在wireguard外面套上一层udp2raw。</p>
<p>具体实现步骤如下：</p>
<p>首先前往<a href="https://github.com/wangyu-/udp2raw-tunnel/releases">下载地址</a>下载udp2raw，然后在落地机器开启server：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#记得更改udp2raw的路径以及password</span>
</span></span><span style="display:flex;"><span>nohup path/to/udp2raw -s -l0.0.0.0:9898 -r 127.0.0.1:52540 --raw-mode faketcp -a -k password &gt;/root/app/logs/udp2raw.log 2&gt;&amp;1 &amp;
</span></span></code></pre></div><p>然后在中转机器开启client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 因为后续要更改wireguard的endpoint到中转机器的udp2raw,所以要先添加转发规则</span>
</span></span><span style="display:flex;"><span>ip route add 1.2.3.4 via <span style="color:#66d9ef">$(</span>ip route | awk <span style="color:#e6db74">&#39;$1==&#34;default&#34; {print $3}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 记得修改udp2raw的路径、ip和password</span>
</span></span><span style="display:flex;"><span>nohup path/to/udp2raw -c -r 1.2.3.4:9898 -l 127.0.0.1:52540 --raw-mode faketcp -k password &gt;/root/udp2raw.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</span></span></code></pre></div><p>修改中转机器的wireguard设置<code>/etc/wireguard/wg0.conf</code></p>
<p>将<code>Endpoint</code>修改为<code>127.0.0.1:52540</code></p>
<p>重启wireguard</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wg-quick down wg0
</span></span><span style="display:flex;"><span>wg-quick up wg0
</span></span></code></pre></div><p>至此完成了将wg伪装为tcp的过程，对于丢包严重的朋友，还可以使用udp2raw作者开发的<a href="https://github.com/wangyu-/UDPspeeder">udpspeeder</a>，具体使用方法请参考其github，关于udp2raw的一些具体用法也有介绍。</p>
<h2 id="鸣谢">鸣谢</h2>
<p><a href="https://blog.chionlab.moe/2018/02/09/full-cone-nat-with-linux/">从DNAT到netfilter内核子系统，浅谈Linux的Full Cone NAT实现</a></p>
<p><a href="https://www.jianshu.com/p/88e7cd6a0c95">Centos 7当网关启用Fullcone nat</a></p>
<p><a href="https://isabelcmdcosta.medium.com/installing-nftables-from-sources-on-debian-eb8c24bbc5ca">Installing nftables from sources on Debian</a></p>
<p><a href="https://github.com/NetchX/Netch">netch</a></p>
<p><a href="https://github.com/wangyu-/udp2raw-tunnel">udp2raw-tunnel</a></p>
<p><a href="https://10101.io/2018/11/10/wireguard">WireGuard 搭建和使用折腾小记</a></p>

</content>
<p>
  
  <a href="http://localhost:1313/blog/tutorials/">#Tutorials</a>
  
  <a href="http://localhost:1313/blog/wireguard/">#Wireguard</a>
  
  <a href="http://localhost:1313/blog/games/">#Games</a>
  
</p>

  </main>
  <footer>
<p>Copyright © spiritshaman (CC BY 4.0)</p></footer>

    
</body>

</html>
